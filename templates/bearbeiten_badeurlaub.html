{% extends "base.html" %}

{% block title %}Reise anzeigen{% endblock %}

{% block body %}
    <h2>Reise bearbeiten</h2>

    <div class="oben-b">
    <h4><strong>Reisedaten</strong></h4>
    <form id="reisezeitraum-form">
        <label for="anreise"><strong>Anreise:</strong></label>
        <input type="date" id="anreise" name="anreise" value="{{ reise.anreise }}" style="width: 16vw; margin-bottom: 8px;">
        <br>
        <label for="abreise"><strong>Abreise:</strong></label>
        <input type="date" id="abreise" name="abreise" value="{{ reise.abreise }}" style="width: 16vw;">
        </form>

    <p><strong>Zielland</strong>: {{ reise.zielland_name }}</p>

     <div class="bearbeiten-links" style="height: 5vh;">
    <a class="link-b" href="{{ url_for('reisen.hinzufuegen_hotel', reise_id=reise._id) }}"><i class="fas fa-plus-circle"></i> Hotel hinzuf√ºgen</a>
    <a class="link-b" href="{{ url_for('reisen.hinzufuegen_flug', reise_id=reise._id) }}"><i class="fas fa-plus-circle" style="margin-top: -10px;"></i> Flug hinzuf√ºgen</a>
    </div>

    <div class="info-Hotel-Flug">
            {% if reise.fluege and reise.fluege | length >= 1 %}
            <div>
                <h4><strong>‚úàÔ∏è Flugdetails</strong></h4>
                <p id="flugInfo" style="width: 400px;">Lade Fluginformationen...</p>
            </div>
            {% else %}
                <p>‚úàÔ∏è Keine Flugdaten verf√ºgbar.</p>
            {% endif %}

              {% if reise.hotels and reise.hotels | length > 0 %}
            <div>
                <h4><strong>üè® Hotels</strong></h4>
                <ul id="hotel-list">
                {% for hotel in reise.hotels %}
                    <li class="hotel-item" data-hotel-id="{{ hotel.id or hotel._id }}">
                    <div class="hotel-top">
                        <span class="hotel-name">
                        <strong>{{ hotel.name }}</strong>
                        <button class="entfernen-button" onclick="entferneHotel('{{ hotel.id or hotel._id }}')">‚úñ</button>
                        </span>
                    </div>
                    <div class="hotel-address">{{ hotel.address }}</div>
                    </li>
                {% endfor %}
                </ul>
            </div>
            {% else %}
            <p>üè® Keine Hotelinformationen verf√ºgbar.</p>
            {% endif %}
        </div>
   
     </div>

    <div class="bearbeiten-buttons">
    <div class="abbrechen">
            <a class="button_abr" style="text-decoration: none;" href="{{ url_for('reisen.anzeigen_badeurlaub', reise_id=reise._id)}}"><span>Abbrechen</span></a>
    </div>
    <button type="submit" class="button"><span>Speichern</span></button>
</div>

<div id="toast" style="
    visibility: hidden;
    opacity: 0;
    min-width: 250px;
    background-color: #4BB543;
    color: white;
    text-align: center;
    border-radius: 8px;
    padding: 12px;
    position: fixed;
    top: 70px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 16px;
    z-index: 9999;
    box-shadow: 0 0 10px rgba(0,0,0,0.3);
    transition: opacity 0.5s ease-in-out, visibility 0.5s ease-in-out;">
    Erfolgreich gespeichert!
</div>

<div id="toast-error" style="
    visibility: hidden;
    opacity: 0;
    min-width: 250px;
    background-color: #ce0000;
    color: white;
    text-align: center;
    border-radius: 8px;
    padding: 12px;
    position: fixed;
    top: 70px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 16px;
    z-index: 9999;
    box-shadow: 0 0 10px rgba(0,0,0,0.3);
    transition: opacity 0.5s ease-in-out, visibility 0.5s ease-in-out;">
    Erfolgreich gespeichert!
</div>

<script>
    const reiseId = "{{ reise._id or reise.id }}";
    const fluege = {{ reise.fluege | default([]) | tojson | safe }};
    const hotels = {{ reise.hotels | default([]) | tojson | safe }};

    
document.querySelector('.bearbeiten-buttons button[type="submit"]').addEventListener('click', async (e) => {
    e.preventDefault();

    const anreise = document.getElementById('anreise').value;
    const abreise = document.getElementById('abreise').value;

    try {
        const response = await fetch(`/reise/${reiseId}/bearbeiten`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                anreise: anreise,
                abreise: abreise,
                fluege: fluege, 
                hotels: hotels
            })
        });

        if (!response.ok) throw new Error("Fehler beim Speichern");

        const result = await response.json();
        zeigeToast("Reise erfolgreich gespeichert!");
        setTimeout(() => {
            window.location.href = `/anzeigen_badeurlaub/${reiseId}`;
        }, 1500);
    } catch (err) {
        console.error(err);
        zeigeToastError("Fehler beim Speichern der Reise.");
    }
});

const formatDate = (iso) =>
  new Date(iso).toLocaleDateString("de-DE", {
    weekday: "short",
    day: "2-digit",
    month: "2-digit",
    year: "numeric",
  });

function renderFluege() {
  const flugInfoDiv = document.getElementById("flugInfo");
  if (flugInfoDiv) {
    flugInfoDiv.innerHTML = "";

    fluege.sort((a, b) => {
      const aDate = new Date(a.itineraries[0].segments[0].departure.at);
      const bDate = new Date(b.itineraries[0].segments[0].departure.at);
      return aDate - bDate;
    });

    fluege.forEach((flug, index) => {
      const segment = flug.itineraries[0].segments[0];

      const flugDiv = document.createElement("div");
      flugDiv.id = `flug-${index}`;
      flugDiv.style.display = "flex";
      flugDiv.style.alignItems = "center";
      flugDiv.style.marginBottom = "5px";
      flugDiv.innerHTML = `
        <span style="flex: 1;">
          üõ´ <strong>Flug:</strong> ${formatDate(segment.departure.at)}
          von ${segment.departure.iataCode} nach ${segment.arrival.iataCode}
        </span>
        <button class="entfernen-button" onclick="entferneFlug(${index})">‚úñ</button>
      `;

      flugInfoDiv.appendChild(flugDiv);
    });
  }
}

function entferneFlug(index) {
  fluege.splice(index, 1);
  renderFluege();
  zeigeToast("Flug entfernt");
}

// Initial render
renderFluege();

function entferneHotel(hotelId) {
  hotels = hotels.filter(hotel => (hotel.id ?? hotel._id) !== hotelId);

  const li = document.querySelector(`li[data-hotel-id="${hotelId}"]`);
  if (li) li.remove();

  zeigeToast("Hotel lokal entfernt. Bitte speichern, um √Ñnderungen zu √ºbernehmen.");
}

function aktualisiereHotelListe() {
  const hotelListElement = document.getElementById('hotel-list');
  if (!hotelListElement) return;

  hotelListElement.innerHTML = '';

  if (hotels.length === 0) {
    hotelListElement.innerHTML = '<p>üè® Keine Hotelinformationen verf√ºgbar.</p>';
    return;
  }

  hotels.forEach(hotel => {
    const hotelId = hotel.id ?? hotel._id;

    const li = document.createElement('li');
    li.classList.add('hotel-item');
    li.setAttribute('data-hotel-id', hotelId);

    const row = document.createElement('div');
    row.classList.add('hotel-row');

    const nameSpan = document.createElement('span');
    nameSpan.innerHTML = `<strong>${hotel.name}</strong> ‚Äì ${hotel.price ?? ''} ${hotel.currency ?? ''}`;

    const removeBtn = document.createElement('button');
    removeBtn.className = 'entfernen-button';
    removeBtn.title = 'Hotel entfernen';
    removeBtn.textContent = '‚úñ';
    removeBtn.addEventListener('click', () => entferneHotel(hotelId));

    row.appendChild(nameSpan);
    row.appendChild(removeBtn);

    const addr = document.createElement('div');
    addr.classList.add('hotel-address');
    addr.textContent = hotel.address ?? '';

    li.appendChild(row);
    li.appendChild(addr);
    hotelListElement.appendChild(li);
  });
}

function zeigeToast(message, dauer = 3000) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.style.visibility = 'visible';
    toast.style.opacity = '1';

    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.visibility = 'hidden';
    }, dauer);
}

function zeigeToastError(message, dauer = 3000) {
    const toast = document.getElementById('toast-error');
    toast.textContent = message;
    toast.style.visibility = 'visible';
    toast.style.opacity = '1';

    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.visibility = 'hidden';
    }, dauer);
}

</script>
{% endblock %}