{% extends "base.html" %}

{% block title %}Meine Reisen{% endblock %}

{% block body %}

<h2>Meine Reisen</h2>

<div class="cont">
  {% for reise in reisen %}
    {% if reise.reiseart == 'roadtrip' %}
    {% set detail_url = url_for('reisen.anzeigen', reise_id=reise._id) %}
  {% elif reise.reiseart == 'städtetrip' %}
    {% set detail_url = url_for('reisen.anzeigen_staedtetrip', reise_id=reise._id) %}
  {% elif reise.reiseart == 'badeurlaub' %}
    {% set detail_url = url_for('reisen.anzeigen_badeurlaub', reise_id=reise._id) %}
  {% else %}
    {% set detail_url = '#' %}
  {% endif %}
<div class="card" data-url="{{ detail_url }}">
    {% if reise.reiseart == 'roadtrip' %}
    <p><strong>{{ reise.reiseart | default('Keine Reiseart angegeben') | title }}  {{ reise.zielland_name }}:</strong> {{ reise.anreise }} bis {{ reise.abreise }} </p>
    <p>  🛑 Zwischenstopps:
    {% if reise.stopps and reise.stopps|length > 1 %}
      {{ reise.stopps | join(' → ') }}
    {% elif reise.stopps %}
      {{ reise.stopps[0] }}
    {% else %}
      Keine Stopps ausgewählt.
    {% endif %}
    </p>
    {% elif reise.reiseart == 'städtetrip' %}
      <p><strong>{{ reise.reiseart | default('Keine Reiseart angegeben') | title }} {{ reise.zielort }}:</strong> {{ reise.anreise }} bis {{reise.abreise }} </p>
      <p> 🗽 Sehenswürdigkeiten: 
        {% if reise.sehenswuerdigkeiten and reise.sehenswuerdigkeiten|length > 1 %}
          {{ reise.sehenswuerdigkeiten | join(' → ') }}
        {% elif reise.sehenswuerdigkeiten %}
          {{ reise.sehenswuerdigkeiten[0] }}
        {% else %}
          Keine Sehenswürdigkeiten ausgewählt
        {% endif %}
      </p>

    {% elif reise.reiseart == 'badeurlaub' %}
      <p><strong>{{ reise.reiseart | default('Keine Reiseart angegeben') | title }}  {{ reise.zielland_name }}:</strong> {{ reise.anreise }} bis {{ reise.abreise }} </p>
      <p>
        {% if reise.fluege and reise.fluege | length >= 1 %}
            <div>
                <h4><strong>✈️ Flugdetails</strong></h4>
                <p id="flugInfo">Lade Fluginformationen...</p>
            </div>
            {% else %}
                <p>✈️ Keine Flugdaten verfügbar.</p>
            {% endif %}

            {% if reise.hotels and reise.hotels | length > 0 %}
            <div>
                <h4><strong>🏨 Hotels</strong></h4>
                <ul>
                {% for hotel in reise.hotels %}
                    <li>
                    <strong>{{ hotel.name }}</strong> – {{ hotel.price }} {{ hotel.currency }}
                    <br>
                    <small>{{ hotel.address }}</small>
                    </li>
                {% endfor %}
                </ul>
            </div>
            {% else %}
            <p>🏨 Keine Hotelinformationen verfügbar.</p>
            {% endif %}
            <p id="preisInfo"></p>
      </p>
    {% endif %}
</div>
  {% endfor %}
</div>


<div class="space-d"></div>

<div class="unten_d">
  <form action="{{ url_for('reisen.add') }}" method="get" class="land-auswahl-form">
    <label for="zielland">Zielland auswählen:</label>
    <select name="zielland" id="zielland" required>
  <option value="">Bitte wählen</option>
  <option value="AD" data-name="Andorra">Andorra</option>
  <option value="AE" data-name="Vereinigte Arabische Emirate">Vereinigte Arabische Emirate</option>
  <option value="AF" data-name="Afghanistan">Afghanistan</option>
  <option value="AG" data-name="Antigua und Barbuda">Antigua und Barbuda</option>
  <option value="AI" data-name="Anguilla">Anguilla</option>
  <option value="AL" data-name="Albanien">Albanien</option>
  <option value="AM" data-name="Armenien">Armenien</option>
  <option value="AO" data-name="Angola">Angola</option>
  <option value="AQ" data-name="Antarktis">Antarktis</option>
  <option value="AR" data-name="Argentinien">Argentinien</option>
  <option value="AT" data-name="Österreich">Österreich</option>
  <option value="AW" data-name="Aruba">Aruba</option>
  <option value="AZ" data-name="Azerbaijan">Azerbaijan</option>
  <option value="BA" data-name="Bosinien und Herzegovina">Bosinien und Herzegovina</option>
  <option value="BD" data-name="Bangladesh">Bangladesh</option>
  <option value="BE" data-name="Belgien">Belgien</option>
  <option value="BG" data-name="Bulgarien">Bulgarien</option>
  <option value="BM" data-name="Bermuda">Bermuda</option>
  <option value="BO" data-name="Bolivien">Bolivien</option>
  <option value="BR" data-name="Brasilien">Brasilien</option>
  <option value="BS" data-name="Bahamas">Bahamas</option>
  <option value="BW" data-name="Botswana">Botswana</option>
  <option value="BY" data-name="Belarus">Belarus</option>
  <option value="BZ" data-name="Belize">Belize</option>
  <option value="CA" data-name="Kanada">Kanada</option>
  <option value="CD" data-name="Dem. Rep. Kongo">Dem. Rep. Kongo</option>
  <option value="CF" data-name="Zentral Afrikanische Republik">Zentral Afrikanische Republik</option>
  <option value="CG" data-name="Republik Kongo">Republik Kongo</option>
  <option value="CH" data-name="Schweiz">Schweiz</option>
  <option value="CL" data-name="Chile">Chile</option>
  <option value="CN" data-name="China">China</option>
  <option value="CO" data-name="Kolumbien">Kolumbien</option>
  <option value="CR" data-name="Costa Rica">Costa Rica</option>
  <option value="CU" data-name="Kuba">Kuba</option>
  <option value="CW" data-name="Curacao">Curacao</option>
  <option value="CX" data-name="Weihnachtsinseln">Weihnachtsinseln</option>
  <option value="CY" data-name="Zypern">Zypern</option>
  <option value="CZ" data-name="Tschechische Republik">Tschechische Republik</option>
  <option value="DE" data-name="Deutschland">Deutschland</option>
  <option value="DK" data-name="Dänemark">Dänemark</option>
  <option value="DM" data-name="Dominika">Dominika</option>
  <option value="DO" data-name="Dominikanische Republik">Dominikanische Republik</option>
  <option value="DZ" data-name="Algerien">Algerien</option>
  <option value="EC" data-name="Equador">Equador</option>
  <option value="EE" data-name="Estland">Estland</option>
  <option value="EG" data-name="Äqypten">Äqypten</option>
  <option value="EH" data-name="West Sahara">West Sahara</option>
  <option value="ES" data-name="Spanien">Spanien</option>
  <option value="ET" data-name="Äthiopien">Äthiopien</option>
  <option value="FI" data-name="Finnland">Finnland</option>
  <option value="FK" data-name="Falklandinseln">Falklandinseln</option>
  <option value="FR" data-name="Frankreich">Frankreich</option>
  <option value="GB" data-name="Großbritannien">Großbritannien</option>
  <option value="GE" data-name="Georgien">Georgien</option>
  <option value="GH" data-name="Ghana">Ghana</option>
  <option value="GL" data-name="Grönland">Grönland</option>
  <option value="GP" data-name="Guadeloupe">Guadeloupe</option>
  <option value="GR" data-name="Griechenland">Griechenland</option>
  <option value="GT" data-name="Guatemala">Guatemala</option>
  <option value="GU" data-name="Guam">Guam</option>
  <option value="HK" data-name="Hong Kong">Hong Kong</option>
  <option value="HR" data-name="Kroatien">Kroatien</option>
  <option value="HT" data-name="Haiti">Haiti</option>
  <option value="HU" data-name="Ungarn">Ungarn</option>
  <option value="ID" data-name="Indonesien">Indonesien</option>
  <option value="IE" data-name="Irland">Irland</option>
  <option value="IL" data-name="Iseael">Iseael</option>
  <option value="IN" data-name="Indien">Indien</option>
  <option value="IQ" data-name="Irak">Irak</option>
  <option value="IR" data-name="Iran">Iran</option>
  <option value="IS" data-name="Island">Island</option>
  <option value="IT" data-name="Italien">Italien</option>
  <option value="JM" data-name="Jamaica">Jamaica</option>
  <option value="JO" data-name="Jordan">Jordan</option>
  <option value="JP" data-name="Japan">Japan</option>
  <option value="KE" data-name="Kenya">Kenya</option>
  <option value="KH" data-name="Kambotscha">Kambotscha</option>
  <option value="KP" data-name="Nord Korea">Nord Korea</option>
  <option value="KR" data-name="Süd Korea">Süd Korea</option>
  <option value="KW" data-name="Kuwait">Kuwait</option>
  <option value="KZ" data-name="Kachsastan">Kachsastan</option>
  <option value="LA" data-name="Laos">Laos</option>
  <option value="LB" data-name="Lebanon">Lebanon</option>
  <option value="LI" data-name="Liechtenstein">Liechtenstein</option>
  <option value="LK" data-name="Sri Lanka">Sri Lanka</option>
  <option value="LT" data-name="Litauen">Litauen</option>
  <option value="LU" data-name="Luxemburg">Luxemburg</option>
  <option value="MA" data-name="Marokko">Marokko</option>
  <option value="MC" data-name="Monaco">Monaco</option>
  <option value="MD" data-name="Moldau">Moldau</option>
  <option value="ME" data-name="Montenegro">Montenegro</option>
  <option value="MG" data-name="Madagascar">Madagascar</option>
  <option value="MN" data-name="Mongolei">Mongolei</option>
  <option value="MQ" data-name="Martinique">Martinique</option>
  <option value="MT" data-name="Malta">Malta</option>
  <option value="MU" data-name="Mauritius">Mauritius</option>
  <option value="MV" data-name="Malediven">Malediven</option>
  <option value="MX" data-name="Mexiko">Mexiko</option>
  <option value="MY" data-name="Malaysien">Malaysien</option>
  <option value="NA" data-name="Namibien">Namibien</option>
  <option value="NG" data-name="Nigerien">Nigerien</option>
  <option value="NL" data-name="Niederlande">Niederlande</option>
  <option value="NO" data-name="Norwegen">Norwegen</option>
  <option value="NZ" data-name="Neuseeland">Neuseeland</option>
  <option value="PA" data-name="Panama">Panama</option>
  <option value="PE" data-name="Peru">Peru</option>
  <option value="PH" data-name="Philipinen">Philipinen</option>
  <option value="PK" data-name="Pakistan">Pakistan</option>
  <option value="PL" data-name="Polen">Polen</option>
  <option value="PS" data-name="Palestina">Palestina</option>
  <option value="PT" data-name="Portugal">Portugal</option>
  <option value="PY" data-name="Paraguay">Paraguay</option>
  <option value="QA" data-name="Qatar">Qatar</option>
  <option value="RE" data-name="Réunion">Réunion</option>
  <option value="RO" data-name="Romänien">Romänien</option>
  <option value="RS" data-name="Serbien">Serbien</option>
  <option value="RU" data-name="Russland">Russland</option>
  <option value="SA" data-name="Saudi Arabien">Saudi Arabien</option>
  <option value="SC" data-name="Seychellen">Seychellen</option>
  <option value="SE" data-name="Schweden">Schweden</option>
  <option value="SG" data-name="Singapur">Singapur</option>
  <option value="SI" data-name="Slowenien">Slowenien</option>
  <option value="SK" data-name="Slowakei">Slowakei</option>
  <option value="SN" data-name="Senegal">Senegal</option>
  <option value="SO" data-name="Somalia">Somalia</option>
  <option value="SS" data-name="Süd Sudan">Süd Sudan</option>
  <option value="TH" data-name="Thailand">Thailand</option>
  <option value="TN" data-name="Tunesien">Tunesien</option>
  <option value="TR" data-name="Türkei">Türkei</option>
  <option value="TW" data-name="Taiwan">Taiwan</option>
  <option value="UA" data-name="Ukraine">Ukraine</option>
  <option value="UG" data-name="Uganda">Uganda</option>
  <option value="US" data-name="Vereinigte Staaten von Amerika">Vereinigte Staaten von Amerika</option>
  <option value="UY" data-name="Uruguay">Uruguay</option>
  <option value="VA" data-name="Vatikan Stadt">Vatikan Stadt</option>
  <option value="VE" data-name="Venezuela">Venezuela</option>
  <option value="VN" data-name="Vietnam">Vietnam</option>
  <option value="ZW" data-name="Zimbabwe">Zimbabwe</option>
</select>
  <input type="hidden" name="zielland_name" id="zielland_name">
    <button type="submit" class="button_p"><span>Neue Reise planen</span></button>
  </form>
</div>

<div class="space"></div>

<div id="toast" style="
    visibility: hidden;
    opacity: 0;
    min-width: 250px;
    background-color: #4BB543;
    color: white;
    text-align: center;
    border-radius: 8px;
    padding: 12px;
    position: fixed;
    top: 70px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 16px;
    z-index: 9999;
    box-shadow: 0 0 10px rgba(0,0,0,0.3);
    transition: opacity 0.5s ease-in-out, visibility 0.5s ease-in-out;">
    Erfolgreich gespeichert!
</div>

<div id="toast-error" style="
    visibility: hidden;
    opacity: 0;
    min-width: 250px;
    background-color: #ce0000;
    color: white;
    text-align: center;
    border-radius: 8px;
    padding: 12px;
    position: fixed;
    top: 70px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 16px;
    z-index: 9999;
    box-shadow: 0 0 10px rgba(0,0,0,0.3);
    transition: opacity 0.5s ease-in-out, visibility 0.5s ease-in-out;">
    Erfolgreich gespeichert!
</div>

<script>
  const reisen = {{ reisen | tojson | safe }};

  document.querySelectorAll('.card').forEach((card, index) => {
    const url = card.getAttribute('data-url');
    if (url) {
      card.style.cursor = 'pointer'; 

      card.addEventListener('click', () => {
        window.location.href = url;
      });

      card.setAttribute('tabindex', '0');
      card.setAttribute('role', 'link');

      card.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' || event.key === ' ') {
          event.preventDefault();
          window.location.href = url;
        }
      });
    }

    const reise = reisen[index];
    if (!reise) return;

    const fluege = reise.fluege || [];
    const hotels = reise.hotels || [];

    const flugInfoEl = card.querySelector('#flugInfo');
    if (flugInfoEl) {
      if (fluege.length === 0) {
        flugInfoEl.innerHTML = '✈️ Keine Flugdaten verfügbar.';
      } else {
        fluege.sort((a, b) => {
          const aDate = new Date(a.itineraries[0].segments[0].departure.at);
          const bDate = new Date(b.itineraries[0].segments[0].departure.at);
          return aDate - bDate;
        });

        let flugPreis = 0;
        let flugText = "";

        const formatDate = (iso) =>
          new Date(iso).toLocaleDateString("de-DE", {
            weekday: "short",
            day: "2-digit",
            month: "2-digit",
            year: "numeric",
          });

        if (fluege.length >= 1) {
          const hinflugSeg = fluege[0].itineraries[0].segments[0];
          const hinflugPreis = parseFloat(fluege[0].price.grandTotal);
          flugPreis += hinflugPreis;

          flugText += `
            🛫 <strong>Hinflug:</strong> ${formatDate(hinflugSeg.departure.at)}
            von ${hinflugSeg.departure.iataCode} nach ${hinflugSeg.arrival.iataCode}<br>
          `;

          if (fluege.length >= 2) {
            const rueckflugSeg = fluege[1].itineraries[0].segments[0];
            const rueckflugPreis = parseFloat(fluege[1].price.grandTotal);
            flugPreis += rueckflugPreis;

            flugText += `
              🛬 <strong>Rückflug:</strong> ${formatDate(rueckflugSeg.departure.at)}
              von ${rueckflugSeg.departure.iataCode} nach ${rueckflugSeg.arrival.iataCode}<br>
            `;
          }
        }

        
        flugInfoEl.innerHTML = flugText;
      }
    }

    const preisInfoEl = card.querySelector('#preisInfo');
    if (preisInfoEl) {
      let hotelPreis = 0;
      if (hotels.length > 0) {
        hotelPreis = hotels.reduce((sum, h) => sum + parseFloat(h.price || 0), 0);
      }

      const flugPreis = fluege.reduce((sum, f) => sum + parseFloat(f.price.grandTotal || 0), 0);

      const gesamt = flugPreis + hotelPreis;

      const formatPreis = (preis) =>
        preis.toLocaleString("de-DE", {
          style: "currency",
          currency: "EUR",
        });

      preisInfoEl.innerText = `✈️ Flugpreis: ${formatPreis(flugPreis)}\n🏨 Hotelpreis: ${formatPreis(hotelPreis)}\n🧳 Gesamtpreis: ${formatPreis(gesamt)}`;
    }
  });


  document.getElementById("zielland").addEventListener("change", function() {
    const selectedOption = this.options[this.selectedIndex];
    const name = selectedOption.getAttribute("data-name");
    document.getElementById("zielland_name").value = name || "";
  });



  function zeigeToast(message, dauer = 3000) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.style.visibility = 'visible';
    toast.style.opacity = '1';

    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.visibility = 'hidden';
    }, dauer);
}

function zeigeToastError(message, dauer = 3000) {
    const toast = document.getElementById('toast-error');
    toast.textContent = message;
    toast.style.visibility = 'visible';
    toast.style.opacity = '1';

    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.visibility = 'hidden';
    }, dauer);
}
</script>


{% endblock %}