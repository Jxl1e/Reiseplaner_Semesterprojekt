{% extends "base.html" %}

{% block title %}Reiseplan{% endblock %}

{% block body %}
<h1>{{ reisedaten.reiseart | default('Keine Reiseart angegeben') | title }} in {{ reisedaten.zielland_name }}</h1>
<h5>von {{ reisedaten.anreise or "?" }} bis {{ reisedaten.abreise or "?" }}</h5>

<div class="hauptbereich">
    <div class="oben_e">
   <div style="display: flex; height: 77vh; width: 100vw;">
    <!-- Karte links -->
    <div class="karte" id="karte" style="height: 100%; min-height: 800px; flex: 2; min-width: 0;"></div>

    <!-- Rechte Seite: flex-Container mit Spalte -->
    <div style="flex: 1; display: flex; flex-direction: column; margin-left: 10px; min-width: 0;">
        <!-- Info oben -->
         <div id="routen-info" style="font-weight: bold; margin-bottom: 10px;"></div>
         <!-- Infokarten-Bereich -->
    <div id="infos-container-wrapper" style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow: hidden; border: 1px solid #ccc; border-radius: 12px;">
    <div style="display: flex; align-items: center; gap: 8px; margin-left: 150px; margin-bottom: 10px; width: 100%; max-width: 300px; margin-top: 8px;">
      <button id="btnZurueck" onclick="zeigeVorigeKarte()" class="info-nav-btn"><span>‚Üê</span></button>
      <button id="btnWeiter" onclick="zeigeNaechsteKarte()" class="info-nav-btn"><span>‚Üí</span></button>
    </div>
    <div id="info-karte"
      style="flex: 1; overflow-y: auto; padding: 10px; border-radius: 12px; min-height: 0; scrollbar-width: thin;">
    </div>
 
    </div>

        <!-- Stopps-Liste unten -->
    <div style="margin-top: 20px; margin-bottom: 8px;">
            <div class="hinzufuegen-stopp" style="display: flex;">
            <div class="autocomplete-wrapper" style="position: relative;">
                <input type="text" id="stopp" name="zielort" placeholder="Stopp hinzuf√ºgen..." autocomplete="off" required>
                <ul id="autocomplete-list" class="autocomplete-list"></ul>
            </div>
             <button class="button-l" onclick="neuenStoppHinzufuegen()" style="margin-left: 5px;"><span>üîç</span></button>
            <div id="stopp-tags"></div>
                <input type="hidden" id="stopp-hidden" name="stopps">
            </div>
        <div id="stopp-liste-container" style="flex: 0 0 200px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; border-radius: 12px; margin-top: 10px; scrollbar-width: thin;">
            <h3>Stopps sortieren</h3>
            <ul id="stopp-liste" style="list-style-type: none; padding-left: 0; margin: 0;"></ul>
        </div>
    </div>
    </div>
</div>
</div>
<div id="lade-box" style="
  display: none;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
  padding: 24px;
  z-index: 9999;
  width: 240px;
  font-family: sans-serif;

  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
">
  <div id="car-animation" style="width: 180px; height: 180px;"></div>
  <div style="margin-top: 5px; font-size: 1rem; color: #444;"><strong>Route wird berechnet...</strong></div>
</div>
     
<form action="{{ url_for('reisen.reise_speichern') }}" method="POST">
    <input type="hidden" name="zielort" value="{{ reisedaten.zielort }}">
    <input type="hidden" name="zielort_plz" value="{{ reisedaten.zielort_plz }}">
    <input type="hidden" name="anreise" value="{{ reisedaten.anreise }}">
    <input type="hidden" name="abreise" value="{{ reisedaten.abreise }}">
    <input type="hidden" name="zielland" value="{{ reisedaten.zielland }}">
    <input type="hidden" name="zielland_name" value="{{ reisedaten.zielland_name }}">

    <input type="hidden" name="reiseart" value="{{ reisedaten.reiseart }}">


    <div class="unten_e">
        <div class="back">
            <a class="button_abr" style="text-decoration: none;" href="{{ url_for('reisen.add') }}"><span>Zur√ºck</span></a>
        </div>
        <button class="button" type="submit"><span>Reise speichern</span></button>
    </div>
    </form>
</div>

<div class="space"></div>


<div id="toast" style="
    visibility: hidden;
    opacity: 0;
    min-width: 250px;
    background-color: #4BB543;
    color: white;
    text-align: center;
    border-radius: 8px;
    padding: 12px;
    position: fixed;
    top: 70px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 16px;
    z-index: 9999;
    box-shadow: 0 0 10px rgba(0,0,0,0.3);
    transition: opacity 0.5s ease-in-out, visibility 0.5s ease-in-out;">
    Erfolgreich gespeichert!
</div>

<div id="toast-error" style="
    visibility: hidden;
    opacity: 0;
    min-width: 250px;
    background-color: #ce0000;
    color: white;
    text-align: center;
    border-radius: 8px;
    padding: 12px;
    position: fixed;
    top: 70px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 16px;
    z-index: 9999;
    box-shadow: 0 0 10px rgba(0,0,0,0.3);
    transition: opacity 0.5s ease-in-out, visibility 0.5s ease-in-out;">
    Erfolgreich gespeichert!
</div>

<script>
    var zielort = {{ reisedaten.zielort | tojson | safe }};
    var stopps = {{ reisedaten.stopps | default ([]) | tojson }};
    const country = {{ reisedaten.zielland | tojson | safe }};
    var orte = stopps.concat([zielort]);

    let karte;
    let punkte = [];
    let initialPunkte = [];
    let markerListe = [];
    let initialMarker = [];
    let routeLinie = null;

    let carAnimation;

    document.addEventListener("DOMContentLoaded", function () {
        console.log("DOM fully loaded and parsed")
        karte = L.map('karte').setView([51.1657, 10.4515], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap-Mitwirkende'
        }).addTo(karte);

      carAnimation = lottie.loadAnimation({
          container: document.getElementById('car-animation'),
          renderer: 'svg',
          loop: true,
          autoplay: true,
          path: '/static/animations/car-animation.json'
        });

        ladeUndZeigeRoute();

       karte?.on('click', async function (e) {
    let latlng = e.latlng;

  document.getElementById('lade-box').style.display = "none";


    // Reverse Geocoding (Nominatim)
    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latlng.lat}&lon=${latlng.lng}`);
    const data = await res.json();
    let ortName = data.address.city || data.address.town || data.address.village || data.display_name || "Neuer Stopp";

    let marker = L.marker(latlng).addTo(karte).bindPopup(ortName).openPopup();
    markerListe.push(marker);
    punkte.push([latlng.lat, latlng.lng]);

    orte.push(ortName);

    aktualisiereStoppListe();
    zeichneRoute();
    });

    });

function zeigeLadeanimation() {
  const ladeBox = document.getElementById("lade-box");
  ladeBox.style.display = "flex";
  carAnimation.play();
}

function versteckeLadeanimation() {
  const ladeBox = document.getElementById("lade-box");
  ladeBox.style.display = "none";
  carAnimation.pause();
}

const stoppInput = document.getElementById("stopp");
const autocompleteList = document.getElementById("autocomplete-list");

stoppInput.addEventListener("input", async () => {
  const query = stoppInput.value.trim();
  if (query.length < 2) {
    autocompleteList.innerHTML = "";
    return;
  }

  const response = await fetch(`/autocomplete_ort?q=${encodeURIComponent(query)}&country=${country}`);
  const data = await response.json();

  // Liste anzeigen
  autocompleteList.innerHTML = "";
  data.results.forEach(item => {
    const li = document.createElement("li");
    li.textContent = item;
    li.style.cursor = "pointer";
    li.addEventListener("click", () => {
      stoppInput.value = item;
      autocompleteList.innerHTML = "";
      // Marker setzen:
      neuenStoppHinzufuegen(item);
    });
    autocompleteList.appendChild(li);
  });
});

async function neuenStoppHinzufuegen(ort) {
  if (!ort) ort = stoppInput.value.trim();
  if (!ort) return zeigeToastError("Bitte einen Ort eingeben.");
  

  const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(ort)}`);
  const daten = await res.json();

  if (daten.length > 0) {
    let lat = parseFloat(daten[0].lat);
    let lon = parseFloat(daten[0].lon);
    let marker = L.marker([lat, lon]).addTo(karte).bindPopup(ort).openPopup();
    markerListe.push(marker);
    punkte.push([lat, lon]);
    orte.push(ort);
    aktualisiereStoppListe();
    await ladeUndZeigeRoute();
    document.getElementById("stopp").value = "";
  } else {
    zeigeToastError("Ort nicht gefunden.");
  }
}


async function ladeUndZeigeRoute() {
let infoBox = document.getElementById("routen-info");
  if (!infoBox) {
      infoBox = document.createElement("div");
      infoBox.id = "routen-info";
      infoBox.style.marginTop = "10px";
      infoBox.style.fontWeight = "bold";
      infoBox.style.fontSize = "1rem";
      document.querySelector(".info")?.prepend(infoBox);
  }

  try {
    zeigeLadeanimation();

    initialPunkte.length = 0;
    initialMarker.length = 0;

    for (let i = 0; i < orte.length; i++) {
      const ort = orte[i];
      const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(ort)}`);
      
      if (!res.ok) throw new Error("Fehler bei Geodaten-Antwort");

      const daten = await res.json();

      if (daten.length > 0) {
        let lat = parseFloat(daten[0].lat);
        let lon = parseFloat(daten[0].lon);

        let marker;
        if (i === orte.length - 1) {
          marker = L.marker([lat, lon], {
            icon: L.icon({
              iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
              iconSize: [30, 30],
              iconAnchor: [15, 30],
              popupAnchor: [0, -30]
            })
          }).addTo(karte).bindPopup(ort + " (Ziel)");
        } else {
          marker = L.marker([lat, lon]).addTo(karte).bindPopup(ort);
        }

        initialMarker.push(marker);
        initialPunkte.push([lat, lon]);
      }
    }

    punkte = [...initialPunkte];
    markerListe = [...initialMarker];

    await zeichneRoute();
    await zeigeInfosZuOrten();
    aktualisiereStoppListe();
  } catch (err) {
    console.error("Fehler beim Laden der Route:", err);
    zeigeToastError("Fehler beim Laden der Route.");
    infoBox.innerHTML = `
          Routing fehlgeschlagen. Bitte versuche es sp√§ter erneut. 
          <button class="button" id="retry-btn"><span>Retry</span></button>
        `;
        const retryBtn = document.getElementById("retry-btn");
        retryBtn.addEventListener("click", async () => {
          retryBtn.disabled = true;
          infoBox.textContent = "Bitte warten...";
          await ladeUndZeigeRoute(); 
          retryBtn.disabled = false;
        });
  } finally {
    versteckeLadeanimation();
    
  }
}



async function zeichneRoute() {

  let infoBox = document.getElementById("routen-info");
  if (!infoBox) {
      infoBox = document.createElement("div");
      infoBox.id = "routen-info";
      infoBox.style.marginTop = "10px";
      infoBox.style.fontWeight = "bold";
      infoBox.style.fontSize = "1rem";
      document.querySelector(".info")?.prepend(infoBox);
  }
  
  if (punkte.length <= 1) {
    return;
  }


  setTimeout(async () => {
    if (routeLinie) karte.removeLayer(routeLinie);

    const body = {
        coordinates: punkte.map(p => [p[1], p[0]]),
        format: "geojson"
    };

    try {
        const res = await fetch('https://api.openrouteservice.org/v2/directions/driving-car/geojson', {
            method: 'POST',
            headers: {
                'Authorization': '5b3ce3597851110001cf624816c4af7ed92a44f3ace4a12340d7cb71',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(body)
        });

        if (!res.ok) {
            throw new Error(`Routing fehlgeschlagen (Status ${res.status})`);
        }

        const data = await res.json();

        routeLinie = L.geoJSON(data, { style: { color: 'red' } }).addTo(karte);
        karte.fitBounds(routeLinie.getBounds());

        const summary = data.features?.[0]?.properties?.summary;
        if (summary) {
            const distKm = (summary.distance / 1000).toFixed(1);
            const dauerMin = Math.round(summary.duration / 60);
            const std = Math.floor(dauerMin / 60);
            const min = dauerMin % 60;

            infoBox.textContent = `Gesamtdistanz: ${distKm} km ‚Äì Fahrzeit: ${std}h ${min}min`;
        }

    } catch (err) {
        console.error(err);

        zeigeToastError("Routing fehlgeschlagen. Bitte versuche es sp√§ter erneut.");
        infoBox.innerHTML = `
          Routing fehlgeschlagen. Bitte versuche es sp√§ter erneut. 
          <button class="button" id="retry-btn"><span>Retry</span></button>
        `;
        const retryBtn = document.getElementById("retry-btn");
        retryBtn.addEventListener("click", async () => {
          retryBtn.disabled = true;
          infoBox.textContent = "Bitte warten...";
          await zeichneRoute(); 
          retryBtn.disabled = false;
        });
        throw err;
    }
  }, 50);
}


async function ladeWikiInfo(ort) {
  const url = `https://de.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(ort)}`;

  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error("Wiki nicht gefunden");
    const daten = await res.json();

    return {
      title: daten.title || stichwort,
      extract: daten.extract || "Keine Beschreibung gefunden.",
      thumbnail: daten.thumbnail?.source || null,
      pageUrl: daten.content_urls?.desktop?.page || "#"
    };
  } catch {
    return null;
  }
}


    function buildOverpassQuery(lat, lon, radius = 1000) {
        return `
    [out:json][timeout:25];
    (
      node["tourism"="attraction"](around:${radius},${lat},${lon});
      way["tourism"="attraction"](around:${radius},${lat},${lon});
      relation["tourism"="attraction"](around:${radius},${lat},${lon});
    );
    out center 10;
    `;
    }


    async function holeSehenswuerdigkeiten(lat, lon) {
        const query = buildOverpassQuery(lat, lon);
        try {
            const res = await fetch("https://overpass-api.de/api/interpreter", {
                method: "POST",
                body: query,
                headers: {
                    'Content-Type': 'text/plain'
                }
            });
            if (!res.ok) throw new Error("Fehler bei Overpass API");
            const data = await res.json();
            return data.elements;
        } catch (e) {
            console.warn("Overpass API Fehler:", e);
            return [];
        }
    }

let aktuelleKarteIndex = 0;
let infoKarten = [];

async function zeigeInfosZuOrten() {
  const orteOhnePlz = orte.map(ort => ort.replace(/^\d+\s*/, ""));

  infoKarten = [];

  const btnGroup = document.createElement('div');
    btnGroup.style.marginTop = "10px";
    btnGroup.classList.add('stopp-button-container');

  for (const ort of orteOhnePlz) {
    const wikiInfo = await ladeWikiInfo(ort);

let lat, lon;
        try {
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(ort)}`);
            const daten = await res.json();
            if (daten.length > 0) {
                lat = parseFloat(daten[0].lat);
                lon = parseFloat(daten[0].lon);
            } else {
                console.warn(`Ort ${ort} nicht gefunden f√ºr POIs.`);
                continue;
            }
        } catch {
            console.warn(`Fehler bei Nominatim f√ºr ${ort}`);
            continue;
        }

        const pois = await holeSehenswuerdigkeiten(lat, lon);

    const karteDiv = document.createElement('div');
    karteDiv.classList.add('detail-box');

    if (wikiInfo) {
      karteDiv.innerHTML = `
        <h3>Info zu ${wikiInfo.title}</h3>
        ${wikiInfo.thumbnail ? `<img src="${wikiInfo.thumbnail}" alt="${wikiInfo.title}" style="max-width:100px; float:left; margin-right:10px;">` : ''}
        <p>${wikiInfo.extract}</p>
        <a href="${wikiInfo.pageUrl}" target="_blank">Mehr lesen</a>
        <div style="clear: both;"></div>
      `;
    } else {
      karteDiv.innerHTML = `<h3>Keine Wikipedia-Info f√ºr "${ort}" gefunden.</h3>`;
    }

if (pois.length > 0) {
            karteDiv.innerHTML += `<h4>Sehensw√ºrdigkeiten in der N√§he von ${ort}:</h4><ul style="margin-left: 1rem; padding-left: 1rem; list-style-type: disc;">`;
            pois.forEach(poi => {
                const name = poi.tags?.name || `POI ${poi.id}`;
                karteDiv.innerHTML += `<li style="margin-left: 8px">${name}</li>`;
            });
            karteDiv.innerHTML += `</ul>`;
        } else {
            karteDiv.innerHTML += `<p>Keine Sehensw√ºrdigkeiten in der N√§he gefunden.</p>`;
        }

    infoKarten.push(karteDiv);
  }

  const btn = document.createElement('button');
        btn.textContent = orteOhnePlz;
        btn.classList.add('stopp-button');
        btn.addEventListener('click', () => {
            zeigeInfoIndex(aktuelleKarteIndex);
        });
        btnGroup.appendChild(btn);


  aktuelleKarteIndex = 0;
  zeigeAktuelleKarte(); 
}

function zeigeAktuelleKarte() {
  const container = document.getElementById("info-karte");
  container.innerHTML = '';
  container.appendChild(infoKarten[aktuelleKarteIndex]);

  document.getElementById("btnZurueck").disabled = aktuelleKarteIndex === 0;
  document.getElementById("btnWeiter").disabled = aktuelleKarteIndex === infoKarten.length - 1;
}

function zeigeNaechsteKarte() {
  if (aktuelleKarteIndex < infoKarten.length - 1) {
    aktuelleKarteIndex++;
    zeigeAktuelleKarte();
  }
}

function zeigeVorigeKarte() {
  if (aktuelleKarteIndex > 0) {
    aktuelleKarteIndex--;
    zeigeAktuelleKarte();
  }
}

function aktualisiereStoppListe() {
    const liste = document.getElementById("stopp-liste");
    liste.innerHTML = "";

    orte.forEach((ort, index) => {
        const li = document.createElement("li");
        li.style.display = "flex";
        li.style.justifyContent = "space-between";
        li.style.alignItems = "center";
        li.style.padding = "5px 10px";
        li.style.margin = "4px 0";
        li.style.border = "1px solid #ccc";
        li.style.borderRadius = "6px";
        li.style.cursor = "grab";

        const name = document.createElement("span");
        name.textContent = ort;

        const btn = document.createElement("button");
        btn.textContent = "‚úñ";
        btn.classList.add("entfernen-button");
        btn.style.marginLeft = "10px";
        btn.style.background = "transparent";
        btn.style.border = "none";
        btn.style.color = "#dc3545";
        btn.style.cursor = "pointer";
        btn.title = "Stopp entfernen";

        btn.onclick = () => {
            orte.splice(index, 1);
            punkte.splice(index, 1);
            karte.removeLayer(markerListe[index]);
            markerListe.splice(index, 1);
            ladeUndZeigeRoute();
            aktualisiereStoppListe();
            zeigeInfosZuOrten();
        };

        li.appendChild(name);
        li.appendChild(btn);
        liste.appendChild(li);
    });

    // Sortable initialisieren oder neu initialisieren
    if (liste._sortable) {
        liste._sortable.destroy();
    }

    liste._sortable = Sortable.create(liste, {
        animation: 150,
        onEnd: function (evt) {
            const altIndex = evt.oldIndex;
            const neuIndex = evt.newIndex;

            const ort = orte.splice(altIndex, 1)[0];
            orte.splice(neuIndex, 0, ort);

            const punkt = punkte.splice(altIndex, 1)[0];
            punkte.splice(neuIndex, 0, punkt);

            markerListe.forEach(m => karte.removeLayer(m));
            markerListe = [];

            punkte.forEach((latlng, i) => {
                const marker = L.marker(latlng).addTo(karte).bindPopup(orte[i]);
                markerListe.push(marker);
            });

            ladeUndZeigeRoute();
            aktualisiereStoppListe(); // Liste neu rendern, da Reihenfolge ge√§ndert
        }
    });
}


document.querySelector('form').addEventListener('submit', (e) => {
    const form = e.target;

    form.querySelectorAll('input[name="stopps"]').forEach(input => input.remove());


    const stoppsDOM = document.querySelectorAll('#stopp-liste li'); 
    stoppsDOM.forEach(el => {
        const stoppName = el.textContent.trim(); 
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'stopps';
        input.value = stoppName;
        form.appendChild(input);
    });
    zeigeToast("Reise erfolgreich gespeichert!")
});

function zeigeToast(message, dauer = 3000) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.style.visibility = 'visible';
    toast.style.opacity = '1';

    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.visibility = 'hidden';
    }, dauer);
}

function zeigeToastError(message, dauer = 3000) {
    const toast = document.getElementById('toast-error');
    toast.textContent = message;
    toast.style.visibility = 'visible';
    toast.style.opacity = '1';

    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.visibility = 'hidden';
    }, dauer);
}

</script>
{% endblock %}