{% extends "base.html" %}

{% block title %}Stopp hinzuf√ºgen{% endblock %}

{% block body %}
<h2>Reise bearbeiten > Stopp hinzuf√ºgen</h2>

<div class="oben_e">
  <div style="display: flex; height: 80vh; width: 100vw;">
    <div class="karte" id="karte" style="flex: 2; min-width: 0;"></div>

    <div style="flex: 1; display: flex; flex-direction: column; margin-left: 10px; min-width: 0;">
      <div class="stopp-eingabe" style="margin-top: 20px;">
        <div style="display: flex; gap: 10px;">
          <input type="text" id="neuerStopp" placeholder="Stopp hinzuf√ºgen..." style="flex:1; width: 15vw;" />
          <button id="btnStoppHinzufuegen" class="button-l"><span>üîç</span></button>
        </div>
      </div>

      <div id="stopp-info" style="border:1px solid #ccc; padding:10px; border-radius:8px; margin: 10px 0; max-height: 700px; overflow-y: auto;">
        <em>Informationen zu ausgew√§hltem Stopp werden hier angezeigt.</em>
      </div>

      <div id="sehenswuerdigkeiten-liste-container" style="flex: 0 0 200px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; border-radius: 12px; margin-top: 10px;">
        <h3>Sehensw√ºrdigkeiten:</h3>
        <ul id="sehenswuerdigkeiten-liste" style="list-style-type: none; padding-left: 0; margin: 0;"></ul>
      </div>
    </div>
  </div>
</div>

<div class="stopps-buttons">
  <div class="abbrechen">
    <a class="button_abr" style="text-decoration: none;" href="{{ url_for('reisen.edit_staedtetrip', reise_id=reise._id) }}"><span>Zur√ºck</span></a>
  </div>
  <button id="speichere-stopps" type="button" class="button"><span>Hinzuf√ºgen</span></button>
</div>

<div id="toast" style="
  visibility: hidden;
  opacity: 0;
  min-width: 250px;
  background-color: #4BB543;
  color: white;
  text-align: center;
  border-radius: 8px;
  padding: 12px;
  position: fixed;
  top: 70px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 16px;
  z-index: 9999;
  box-shadow: 0 0 10px rgba(0,0,0,0.3);
  transition: opacity 0.5s ease-in-out, visibility 0.5s ease-in-out;">
  Erfolgreich hinzugef√ºgt!
</div>

<div id="toast-error" style="
    visibility: hidden;
    opacity: 0;
    min-width: 250px;
    background-color: #ce0000;
    color: white;
    text-align: center;
    border-radius: 8px;
    padding: 12px;
    position: fixed;
    top: 70px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 16px;
    z-index: 9999;
    box-shadow: 0 0 10px rgba(0,0,0,0.3);
    transition: opacity 0.5s ease-in-out, visibility 0.5s ease-in-out;">
    Erfolgreich gespeichert!
</div>

<script>
  const reiseId = "{{ reise._id or reise.id }}";
  let zielort = {{ reise.zielort | tojson | safe }};
  let sehenswuerdigkeiten = {{ reise.sehenswuerdigkeiten | default([]) | tojson | safe }};
  if (!Array.isArray(sehenswuerdigkeiten)) sehenswuerdigkeiten = [];

  let karte, punkte = [], markerListe = [], routeLinie = null;
  const aktuellerModus = "foot";
  const input = document.getElementById("neuerStopp");

  document.addEventListener("DOMContentLoaded", async () => {
    karte = L.map("karte").setView([51.1657, 10.4515], 13);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "¬© OpenStreetMap-Mitwirkende"
    }).addTo(karte);

    const zielKoord = await geocodeOrt(zielort);
    if (zielKoord) {
      karte.setView(zielKoord, 13);
    }

    for (let ort of sehenswuerdigkeiten) {
      const koord = await geocodeOrt(ort);
      if (koord) {
        punkte.push(koord);
        const marker = L.marker(koord).addTo(karte).bindPopup(ort);
        markerListe.push(marker);
      }
    }

    aktualisiereStoppListe();
    zeichneRoute();
  });

  document.getElementById("btnStoppHinzufuegen").addEventListener("click", neuenStoppHinzufuegen);
  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      neuenStoppHinzufuegen();
    }
  });

  async function geocodeOrt(ort) {
    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(ort)}&limit=1`);
    const daten = await res.json();
    if (daten.length > 0) return [parseFloat(daten[0].lat), parseFloat(daten[0].lon)];
    return null;
  }

  async function neuenStoppHinzufuegen() {
    const ort = input.value.trim();
    if (!ort) return;

    const koord = await geocodeOrt(ort);
    if (!koord) {
      zeigeToastError("Ort nicht gefunden");
      return;
    }

    punkte.push(koord);
    sehenswuerdigkeiten.push(ort);

    const marker = L.marker(koord).addTo(karte).bindPopup(ort).openPopup();
    markerListe.push(marker);

    input.value = "";
    aktualisiereStoppListe();
    zeichneRoute();
    zeigeStoppInfos(ort, koord[0], koord[1]);
    zeigeToast("Stopp hinzugef√ºgt!");
  }

  async function zeichneRoute() {
    if (punkte.length < 2) return;
    if (routeLinie) karte.removeLayer(routeLinie);

    const body = {
      coordinates: punkte.map(p => [p[1], p[0]]),
      format: "geojson"
    };

    try {
      const res = await fetch(`https://api.openrouteservice.org/v2/directions/foot-walking/geojson`, {
        method: "POST",
        headers: {
          "Authorization": "5b3ce3597851110001cf624816c4af7ed92a44f3ace4a12340d7cb71",
          "Content-Type": "application/json"
        },
        body: JSON.stringify(body)
      });
      const data = await res.json();
      routeLinie = L.geoJSON(data, { style: { color: "blue" } }).addTo(karte);
      karte.fitBounds(routeLinie.getBounds());
    } catch (err) {
      console.error(err);
      zeigeToastError("Routing fehlgeschlagen.");
    }
  }

  function aktualisiereStoppListe() {
    const liste = document.getElementById("sehenswuerdigkeiten-liste");
    liste.innerHTML = "";

    sehenswuerdigkeiten.forEach((ort, index) => {
      const li = document.createElement("li");
      li.style.display = "flex";
      li.style.justifyContent = "space-between";
      li.style.alignItems = "center";
      li.style.padding = "5px";
      li.style.border = "1px solid #ccc";
      li.style.marginBottom = "5px";

      const span = document.createElement("span");
      span.textContent = ort;
      span.style.cursor = "pointer";
      span.onclick = () => zeigeStoppInfos(ort, punkte[index][0], punkte[index][1]);

      const btnEntfernen = document.createElement("button");
      btnEntfernen.textContent = "‚úñ";
      btnEntfernen.title = "Entfernen";
      btnEntfernen.style.marginLeft = "10px";
      btnEntfernen.onclick = () => {
        sehenswuerdigkeiten.splice(index, 1);
        punkte.splice(index, 1);
        karte.removeLayer(markerListe[index]);
        markerListe.splice(index, 1);
        aktualisiereStoppListe();
        zeichneRoute();
      };

      li.appendChild(span);
      li.appendChild(btnEntfernen);
      liste.appendChild(li);
    });

    if (liste._sortable) liste._sortable.destroy();
    liste._sortable = Sortable.create(liste, {
      animation: 150,
      onEnd: evt => {
        const { oldIndex, newIndex } = evt;
        [sehenswuerdigkeiten, punkte, markerListe].forEach(arr => {
          const el = arr.splice(oldIndex, 1)[0];
          arr.splice(newIndex, 0, el);
        });
        zeichneRoute();
      }
    });
  }

  async function zeigeStoppInfos(name, lat, lon) {
    const infoDiv = document.getElementById("stopp-info");
    infoDiv.innerHTML = `<p><strong>${name}</strong> wird geladen...</p>`;

    function bereinigeOrtname(ort) {
      const teile = ort.trim().split(" ");
      if (teile.length > 1 && /^\d{4,5}$/.test(teile[0])) {
        return teile.slice(1).join(" ");
      }
      return ort;
    }

    async function holeWikiBeschreibung(query) {
      try {
        const url = `https://de.wikipedia.org/w/api.php?action=query&prop=extracts&exintro&explaintext&format=json&origin=*&titles=${encodeURIComponent(query)}`;
        const res = await fetch(url);
        const data = await res.json();
        const page = Object.values(data.query.pages)[0];
        return page.extract || "Keine Beschreibung gefunden.";
      } catch {
        zeigeToastError("Fehler beim Laden der Wikipedia-Daten.");
      }
    }

    const beschreibung = await holeWikiBeschreibung(bereinigeOrtname(name));
    infoDiv.innerHTML = `<h3>${name}</h3><p>${beschreibung}</p>`;
  }

  function zeigeToast(message, dauer = 3000) {
    const toast = document.getElementById("toast");
    toast.textContent = message;
    toast.style.visibility = "visible";
    toast.style.opacity = "1";
    setTimeout(() => {
      toast.style.opacity = "0";
      toast.style.visibility = "hidden";
    }, dauer);
  }

  function zeigeToastError(message, dauer = 3000) {
    const toast = document.getElementById('toast-error');
    toast.textContent = message;
    toast.style.visibility = 'visible';
    toast.style.opacity = '1';

    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.visibility = 'hidden';
    }, dauer);
}

  document.getElementById("speichere-stopps").addEventListener("click", async () => {
  try {
    const response = await fetch(`/hinzufuegen_staedtetrip/${reiseId}/stopps`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        sehenswuerdigkeiten: sehenswuerdigkeiten
      })
    });

    const result = await response.json();

    if (response.ok) {
      zeigeToast("Stopps gespeichert!");
setTimeout(() => {
  window.location.href = `/edit_staedtetrip/${reiseId}`;
}, 1500);
    } else {
      zeigeToastError("Fehler: " + result.message);
    }
  } catch (error) {
    console.error("Fehler beim Speichern:", error);
    zeigeToastError("Es ist ein Fehler aufgetreten.");
  }
});
</script>
{% endblock %}
