{% extends "base.html" %}

{% block title %}Reise anzeigen{% endblock %}

{% block body %}
<h1>{{ reise.reiseart | default('Keine Reiseart angegeben') | title }} nach {{ reise.zielort }}</h1>
<h3>von {{ reise.anreise or "?" }} bis {{ reise.abreise or "?" }}</h3>
<div class="oben-s">
  <div style="display:flex; gap: 20px; height: 80vh;">
    <!-- Linke Seite: Karte -->
    <div style="flex: 3; min-width: 0;">
      <div id="karte" style="height: 100%; min-height: 800px;"></div>
    </div>

    <!-- Rechte Seite -->
    <div style="flex: 1.2; max-width: 360px; display: flex; flex-direction: column; height: 100%;">
      <!-- Reiseinfos -->
      <div id="routen-info" style="font-weight: bold; margin-bottom: 10px;"></div>

      <!-- Infokarten-Bereich -->
      <div id="infos-container-wrapper" style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow: hidden; border: 1px solid #ccc; border-radius: 12px; max-height: 500px;">
      <div style="display: flex; align-items: center; gap: 8px; margin-left: 150px; margin-bottom: 10px; width: 100%; max-width: 300px; margin-top: 8px;">
        <button id="btnZurueck" onclick="zeigeVorigeKarte()" class="info-nav-btn"><span>‚Üê</span></button>
        <button id="btnWeiter" onclick="zeigeNaechsteKarte()" class="info-nav-btn"><span>‚Üí</span></button>
    </div>
    <div id="info-karte" style="flex: 1; overflow-y: auto; padding: 10px; border-radius: 12px; min-height: 0; scrollbar-width: thin;">
    </div>
    
  </div>

  <div class="info-Hotel-Flug">
              {% if reise.fluege and reise.fluege | length >= 1 %}
              <div>
                  <h4><strong>‚úàÔ∏è Flugdetails</strong></h4>
                  <p id="flugInfo">Lade Fluginformationen...</p>
              </div>
              {% else %}
                  <p>‚úàÔ∏è Keine Flugdaten verf√ºgbar.</p>
              {% endif %}

              {% if reise.hotels and reise.hotels | length > 0 %}
              <div>
                  <h4><strong>üè® Hotels</strong></h4>
                  <ul>
                  {% for hotel in reise.hotels %}
                      <li>
                      <strong>{{ hotel.name }}</strong> ‚Äì {{ hotel.price }} {{ hotel.currency }}
                      <br>
                      <small>{{ hotel.address }}</small>
                      </li>
                  {% endfor %}
                  </ul>
              </div>
              {% else %}
              <p>üè® Keine Hotelinformationen verf√ºgbar.</p>
              {% endif %}
              <p id="preisInfo"></p>
          </div>
          <div class="linie"></div>
          <div class="preis">
            <div id="gesamtPreis">0,00‚Ç¨</div>
        </div>

  </div>
</div>

<div id="lade-box-staedtetrip" style="
  display: none;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
  padding: 24px;
  z-index: 9999;
  width: 240px;
  font-family: sans-serif;

  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
">
  <div id="lauf-animation" style="width: 180px; height: 180px;"></div>
  <div style="margin-top: 5px; font-size: 1rem; color: #444;"><strong>Route wird berechnet...</strong></div>
</div>

    <div class="anzeigen-buttons">
    <div class="abbrechen">
            <a class="button_abr" style="text-decoration: none;" href="/"><span>Zur√ºck</span></a>
    </div>
    <a href="{{ url_for('reisen.edit_staedtetrip', reise_id=reise._id) }}" class="button" style="text-decoration: none;"><span>Reise bearbeiten</span></a>
    </div>

    <div class="space"></div>

   
<div id="toast" style="
    visibility: hidden;
    opacity: 0;
    min-width: 250px;
    background-color: #4BB543;
    color: white;
    text-align: center;
    border-radius: 8px;
    padding: 12px;
    position: fixed;
    top: 70px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 16px;
    z-index: 9999;
    box-shadow: 0 0 10px rgba(0,0,0,0.3);
    transition: opacity 0.5s ease-in-out, visibility 0.5s ease-in-out;">
    Erfolgreich gespeichert!
</div>

<div id="toast-error" style="
    visibility: hidden;
    opacity: 0;
    min-width: 250px;
    background-color: #ce0000;
    color: white;
    text-align: center;
    border-radius: 8px;
    padding: 12px;
    position: fixed;
    top: 70px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 16px;
    z-index: 9999;
    box-shadow: 0 0 10px rgba(0,0,0,0.3);
    transition: opacity 0.5s ease-in-out, visibility 0.5s ease-in-out;">
    Erfolgreich gespeichert!
</div>

<script>
    var zielort = {{ reise.zielort | tojson | safe }};
    const fluege = {{ reise.fluege | default([]) | tojson | safe }};
    const hotels = {{ reise.hotels | default([]) | tojson | safe }};
    console.log("Hotels:", hotels);
    var sehenswuerdigkeiten = {{ reise.sehenswuerdigkeiten | default([]) | tojson | safe }};
    if (!Array.isArray(sehenswuerdigkeiten)) {
        sehenswuerdigkeiten = [];
    }
      
    let karte;
    let punkte = [];
    let markerListe = [];
    let routeLinie = null;
    let aktuellerModus = "foot";

document.addEventListener("DOMContentLoaded", async () => {
    karte = L.map("karte").setView([51.1657, 10.4515], 13);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "¬© OpenStreetMap-Mitwirkende"
    }).addTo(karte);

    laufAnimation = lottie.loadAnimation({
      container: document.getElementById('lauf-animation'),
      renderer: 'svg',
      loop: true,
      autoplay: false,
      path: '/static/animations/walk-animation.json'
  });

  document.getElementById('lade-box-staedtetrip').style.display = "none";

 await ladeUndZeigeRoute();
});

async function geocodeOrt(ort) {
    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(ort)}&limit=1`);
    const daten = await res.json();
    if (daten.length > 0) {
        return [parseFloat(daten[0].lat), parseFloat(daten[0].lon)];
    }
    return null;
}

function zeigeLadeanimation() {
  const ladeBox = document.getElementById("lade-box-staedtetrip");
  ladeBox.style.display = "flex";
  laufAnimation.play();
}

function versteckeLadeanimation() {
  const ladeBox = document.getElementById("lade-box-staedtetrip");
  ladeBox.style.display = "none";
  laufAnimation.pause();
}


async function ladeUndZeigeRoute() {
  let infoBox = document.getElementById("routen-info");
  if (!infoBox) {
      infoBox = document.createElement("div");
      infoBox.id = "routen-info";
      infoBox.style.marginTop = "10px";
      infoBox.style.fontWeight = "bold";
      infoBox.style.fontSize = "1rem";
      document.querySelector(".info")?.prepend(infoBox);
  }

  try {
    zeigeLadeanimation();

    await new Promise(r => setTimeout(r, 100)); 

   punkte.length = 0;
    markerListe.forEach(m => karte.removeLayer(m));
    markerListe.length = 0;

    const zielKoord = await geocodeOrt(zielort);
    if (!zielKoord) throw new Error("Zielort nicht gefunden");
    karte.setView(zielKoord, 13);

    for (let ort of sehenswuerdigkeiten) {
      let koord = await geocodeOrt(ort);
      if (koord) {
        punkte.push(koord);
        const marker = L.marker(koord).addTo(karte).bindPopup(ort);
        markerListe.push(marker);
      }
    }


    await zeichneRoute();
    await zeigeInfosZuOrten();

  } catch (err) {
    console.error("Fehler beim Laden der Route:", err);
    zeigeToastError("Fehler beim Laden der Route.");
    infoBox.innerHTML = `
      Routing fehlgeschlagen. Bitte versuche es sp√§ter erneut. 
      <button class="button" id="retry-btn"><span>Retry</span></button>
    `;
    const retryBtn = document.getElementById("retry-btn");
    retryBtn.addEventListener("click", async () => {
      retryBtn.disabled = true;
      infoBox.textContent = "Bitte warten...";
      await ladeUndZeigeRoute();
      retryBtn.disabled = false;
    });

  } finally {
    versteckeLadeanimation();
  }
}

async function zeichneRoute() {
    if (punkte.length < 2) return;

    if (routeLinie) {
        karte.removeLayer(routeLinie);
    }

    
    let profile = (aktuellerModus === "transit") ? "driving-car" : "foot-walking";
    
    const body = {
        coordinates: punkte.map(p => [p[1], p[0]]),
        format: "geojson"
    };

    try {
        const res = await fetch(`https://api.openrouteservice.org/v2/directions/${profile}/geojson`, {
            method: "POST",
            headers: {
                "Authorization": "5b3ce3597851110001cf624816c4af7ed92a44f3ace4a12340d7cb71",
                "Content-Type": "application/json"
            },
            body: JSON.stringify(body)
        });
        if (!res.ok) throw new Error("Routing Fehler");
        const data = await res.json();

        routeLinie = L.geoJSON(data, { style: { color: "blue" } }).addTo(karte);
        karte.fitBounds(routeLinie.getBounds());

        zeigeRouteInfo(data);
        zeigeHotels();

    } catch (err) {
        console.error(err);
        zeigeToastError("Routing fehlgeschlagen. Bitte versuche es sp√§ter erneut.");
          infoBox.innerHTML = `
        Routing fehlgeschlagen. Bitte versuche es sp√§ter erneut. 
        <button class=button id="retry-btn"><span>Retry</span></button>
      `;
      const retryBtn = document.getElementById("retry-btn");
      retryBtn.addEventListener("click", async () => {
        retryBtn.disabled = true;
        infoBox.textContent = "Bitte warten...";
        await zeichneRoute();
        retryBtn.disabled = false;
      });
          }
}
console.log("zeigeHotels wird ausgef√ºhrt");
function zeigeHotels() {
    for (const hotel of hotels) {
        const koord = [hotel.lat, hotel.lon];
        L.marker(koord, {
            icon: L.icon({
                iconUrl: 'https://cdn-icons-png.flaticon.com/512/139/139899.png',
                iconSize: [30, 30],
                iconAnchor: [15, 30],
                popupAnchor: [0, -30]
            })
        })
        .addTo(karte)
        .bindPopup(`<b>${hotel.name || "Hotel"}</b><br>${hotel.address}`);
    }
}



function zeigeRouteInfo(data) {
    const summary = data.features?.[0]?.properties?.summary;
    if (!summary) return;

    const distKm = (summary.distance / 1000).toFixed(1);
    const dauerMin = Math.round(summary.duration / 60);
    const std = Math.floor(dauerMin / 60);
    const min = dauerMin % 60;

    const infoBox = document.getElementById("routen-info");
    infoBox.textContent = `Distanz: ${distKm} km, Dauer: ${std}h ${min}min`;
}

async function neuenStoppHinzufuegen() {
    const feld = document.getElementById("neuerStopp");
    const ort = feld.value.trim();
    if (!ort) return;

    const koord = await geocodeOrt(ort);
    if (!koord) {
        alert("Ort nicht gefunden");
        return;
    }

    punkte.push(koord);
    sehenswuerdigkeiten.push(ort);

    const marker = L.marker(koord).addTo(karte).bindPopup(ort).openPopup();
    markerListe.push(marker);

    feld.value = "";
    zeichneRoute();
    zeigeInfosZuOrten();
}


let aktuelleKarteIndex = 0;
let infoKarten = [];

async function zeigeInfosZuOrten() {
  const bereinigterZielort = zielort.replace(/^\d+\s*/, "");
  const orte = [bereinigterZielort, ...sehenswuerdigkeiten];

  infoKarten = [];

  const btnGroup = document.createElement('div');
    btnGroup.style.marginTop = "10px";
    btnGroup.classList.add('sehenswuerdigkeiten-button-container');

  for (const ort of orte) {
    const wikiInfo = await ladeWikiInfo(ort);
    const karteDiv = document.createElement('div');
    karteDiv.classList.add('detail-box');

    if (wikiInfo) {
      karteDiv.innerHTML = `
        <h3>${wikiInfo.title}</h3>
        ${wikiInfo.thumbnail ? `<img src="${wikiInfo.thumbnail}" alt="${wikiInfo.title}" style="max-width:100px; float:left; margin-right:10px;">` : ''}
        <p>${wikiInfo.extract}</p>
        <a href="${wikiInfo.pageUrl}" target="_blank">Mehr lesen</a>
        <div style="clear: both;"></div>
      `;
    } else {
      karteDiv.innerHTML = `<h3>Keine Wikipedia-Info f√ºr "${ort}" gefunden.</h3>`;
    }

    infoKarten.push(karteDiv);
  }

  const btn = document.createElement('button');
        btn.textContent = sehenswuerdigkeiten;
        btn.classList.add('sehesnwuerdigkeiten-button');
        btn.addEventListener('click', () => {
            zeigeInfoIndex(aktuelleKarteIndex);
        });
        btnGroup.appendChild(btn);


  aktuelleKarteIndex = 0;
  zeigeAktuelleKarte(); 
}

function zeigeAktuelleKarte() {
  const container = document.getElementById("info-karte");
  container.innerHTML = '';

  const aktuelleKarte = infoKarten[aktuelleKarteIndex];
  console.log("Aktuelle Karte:", aktuelleKarteIndex, aktuelleKarte);

  if (!aktuelleKarte) {
    container.innerHTML = "<p>Keine Infos verf√ºgbar.</p>";
    return;
  }

  container.appendChild(aktuelleKarte);
  
  document.getElementById("btnZurueck").disabled = aktuelleKarteIndex === 0;
  document.getElementById("btnWeiter").disabled = aktuelleKarteIndex === infoKarten.length - 1;
}

function zeigeNaechsteKarte() {
  if (aktuelleKarteIndex < infoKarten.length - 1) {
    aktuelleKarteIndex++;
    zeigeAktuelleKarte();
  }
}

function zeigeVorigeKarte() {
  if (aktuelleKarteIndex > 0) {
    aktuelleKarteIndex--;
    zeigeAktuelleKarte();
  }
}


async function ladeWikiInfo(stichwort) {
  const url = `https://de.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(stichwort)}`;

  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error("Wiki nicht gefunden");
    const daten = await res.json();

    return {
      title: daten.title || stichwort,
      extract: daten.extract || "Keine Beschreibung gefunden.",
      thumbnail: daten.thumbnail?.source || null,
      pageUrl: daten.content_urls?.desktop?.page || "#"
    };
  } catch {
    return null;
  }
}

document.addEventListener('DOMContentLoaded', () => {
    ladeUndZeigeRoute();
});

// Flugdaten sortieren (Hin- vor R√ºckflug)
fluege.sort((a, b) => {
  const aDate = new Date(a.itineraries[0].segments[0].departure.at);
  const bDate = new Date(b.itineraries[0].segments[0].departure.at);
  return aDate - bDate;
});

const formatDate = (iso) =>
  new Date(iso).toLocaleDateString("de-DE", {
    weekday: "short",
    day: "2-digit",
    month: "2-digit",
    year: "numeric",
  });

let flugPreis = 0;
let flugText = "";

if (fluege.length >= 1) {
  const hinflugSeg = fluege[0].itineraries[0].segments[0];
  const hinflugPreis = parseFloat(fluege[0].price.grandTotal);
  flugPreis += hinflugPreis;

  flugText += `
    üõ´ <strong>Hinflug:</strong> ${formatDate(hinflugSeg.departure.at)}
    von ${hinflugSeg.departure.iataCode} nach ${hinflugSeg.arrival.iataCode}<br>
    <small>Preis Hinflug: ${hinflugPreis.toFixed(2)} EUR</small><br>
  `;

  if (fluege.length >= 2) {
    const rueckflugSeg = fluege[1].itineraries[0].segments[0];
    const rueckflugPreis = parseFloat(fluege[1].price.grandTotal);
    flugPreis += rueckflugPreis;

    flugText += `
      üõ¨ <strong>R√ºckflug:</strong> ${formatDate(rueckflugSeg.departure.at)}
      von ${rueckflugSeg.departure.iataCode} nach ${rueckflugSeg.arrival.iataCode}<br>
      <small>Preis R√ºckflug: ${rueckflugPreis.toFixed(2)} EUR</small><br>
    `;
  }
}

const flugBox = document.getElementById("flugInfo");
if (flugBox) {
  flugBox.innerHTML = flugText;
}

let hotelPreis = 0;
if (hotels && hotels.length > 0) {
  hotelPreis = hotels.reduce((sum, h) => sum + parseFloat(h.price || 0), 0);
}

const gesamt = flugPreis + hotelPreis;

const formatPreis = (preis) =>
  preis.toLocaleString("de-DE", {
    style: "currency",
    currency: "EUR",
  });

if (document.getElementById("preisInfo")) {
  document.getElementById("preisInfo").innerText = `
    ‚úàÔ∏è Flugpreis: ${formatPreis(flugPreis)}\nüè® Hotelpreis: ${formatPreis(hotelPreis)}
  `;
}

document.getElementById("gesamtPreis").innerText = `üß≥ Gesamtpreis (Hotel + Flug): ${formatPreis(gesamt)}`;

function zeigeToast(message, dauer = 3000) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.style.visibility = 'visible';
    toast.style.opacity = '1';

    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.visibility = 'hidden';
    }, dauer);
}

function zeigeToastError(message, dauer = 3000) {
    const toast = document.getElementById('toast-error');
    toast.textContent = message;
    toast.style.visibility = 'visible';
    toast.style.opacity = '1';

    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.visibility = 'hidden';
    }, dauer);
}

</script>
{% endblock %}